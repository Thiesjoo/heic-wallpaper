<!DOCTYPE html>
<html>

<head>
  <title>File Upload</title>

  <!-- Dropping files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.7.1/min/dropzone.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.7.1/min/dropzone.min.css" />

  <!-- Styling the page -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Toast notifications -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">


  <style>
    .dropzone {
      box-shadow: 0px 2px 20px 0px #f2f2f2;
      border: 1px dashed #c0ccda;
      padding: 60x;
      border-radius: 10px;
      background-color: #fbfdff;
      margin-left: 15px;
      margin-bottom: 15px;
      margin-top: 15px;
    }
  </style>
</head>

<body>
  <header>
    <form action="/upload" class="dropzone" id="my-dropzone" method="POST"></form>
  </header>
  <h3 class="text-center text-xxl w-full">Get your dynamic wallpapers from here: <a
      href="https://dynamicwallpaper.club/gallery" target="_blank" rel="noreferrer">dynamicwallpaper.club</a> </h3>
  <section class="w-full mr-5 ml-5 flex justify-center flex-col">
    <h3 class="text-center text-xl text-emerald-300">All available wallpapers</h3>
    <div id="content" class="w-full h-full flex flex-wrap"></div>
  </section>
  <footer class="absolute bottom-0 p-4 w-full justify-center flex">Thies Nieborg</footer>

  <!-- THIS IS TEMPLATE FOR ALL WALLPAPER DISPLAYS -->
  <div class="w-80 h-40 flex-col flex justify-center align-center border p-3 m-3 hidden" onclick="handleClick(this)"
    ondblclick="handleDoubleClick(this)" id="template">
    <img src="/static/processed/86b2204b-8803-4f82-bebe-9e8fe991bb15.heic/preview.png" class="w-full max-h-[90%]"
      style="object-fit: cover" />
    <span class="w-full text-center" id="title">Title</span>
  </div>
  <!-- END OF TEMPLATE -->
</body>

<script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
<script type="text/javascript">
  const notyf = new Notyf({ position: { x: "right", y: "top" } });

  function handleDoubleClick(e) {
    window.open(e.dataset.url, "_blank").focus()
  }

  function handleClick(e) {
    const customURL = e.dataset.url;
    navigator.clipboard
      .writeText(customURL)
      .then((x) => {
        notyf.success(`Copied URL to your clipboard`);
      })
  }

  Dropzone.options.myDropzone = {
    // Prevents Dropzone from uploading dropped files immediately
    autoProcessQueue: true,
    uploadMultiple: false,
    parallelUploads: 5,
    maxFilesize: 100,
    accept(file, done) {
      if (!file.name.endsWith(".heic")) {
        notyf.error("You can only upload .heic files for now")
        return done("Sorry we do not supported files other than .heic yet");
      }
      return done();
    },
    success(file) {
      notyf.success("File upload was a success!")
      this.removeFile(file);
    },
  };

  function fetchAllWallpapers() {
    fetch("/wallpapers")
      .then((x) => x.json())
      .then((x) => {
        const final_location = document.getElementById("content");
        const template = document.getElementById("template");

        const ids = new Set([...final_location.childNodes].map(x => x.id))

        x.forEach((y, i) => {
          ids.delete(y.id)
          let copy;
          if (document.getElementById(y.id)) {
            copy = document.getElementById(y.id)
          } else {
            copy = template.cloneNode(true);
            final_location.appendChild(copy);
          }

          copy.classList.remove("hidden");
          copy.id = y.id;
          copy.title = y.id;
          copy.dataset.url = window.location.href + y.location

          const img = copy.childNodes[1];
          const span = copy.childNodes[3];
          img.classList.remove("blur-sm")

          if (y.pending) {
            // Pending has the task id
            img.classList.add("blur-sm")
            span.textContent = "This image is still being processed"
          } else {
            span.textContent = y.name.substr(0, 10) + "....";
            img.src = y.preview_url;
          }
        });

        ids.forEach(y => {
          console.log("ID:", y, "was in dom, but not in array")
          document.getElementById(y).remove()
        })
      });
  }

  fetchAllWallpapers()
  setInterval(fetchAllWallpapers, 1000)
</script>

</html>